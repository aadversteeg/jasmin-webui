@inject EventFilterState FilterState

<div class="dropdown">
    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
            data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
        Event Types (@FilterState.EnabledEventTypes.Count / @TotalEventTypes)
    </button>
    <div class="dropdown-menu p-3 event-type-filter" style="min-width: 280px;">
        <div class="d-flex gap-2 mb-2">
            <button class="btn btn-sm btn-outline-primary" @onclick="SelectAll">Select All</button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="DeselectAll">Deselect All</button>
        </div>
        <hr class="my-2" />

        @foreach (var category in EventTypeCategories)
        {
            <div class="event-type-category">@category.Key</div>
            @foreach (var eventType in category.Value)
            {
                <div class="form-check form-check-sm">
                    <input class="form-check-input" type="checkbox" id="@($"evt-{eventType}")"
                           checked="@FilterState.IsEventTypeEnabled(eventType)"
                           @onchange="e => OnEventTypeChanged(eventType, (bool)e.Value!)" />
                    <label class="form-check-label" for="@($"evt-{eventType}")">
                        @GetEventTypeDisplay(eventType)
                    </label>
                </div>
            }
        }
    </div>
</div>

@code {
    private static readonly int TotalEventTypes = Enum.GetValues<McpServerEventType>().Length;

    private static readonly Dictionary<string, McpServerEventType[]> EventTypeCategories = new()
    {
        ["Lifecycle"] = new[] {
            McpServerEventType.Starting,
            McpServerEventType.Started,
            McpServerEventType.StartFailed,
            McpServerEventType.Stopping,
            McpServerEventType.Stopped,
            McpServerEventType.StopFailed
        },
        ["Configuration"] = new[] {
            McpServerEventType.ConfigurationCreated,
            McpServerEventType.ConfigurationUpdated,
            McpServerEventType.ConfigurationDeleted
        },
        ["Tools"] = new[] {
            McpServerEventType.ToolsRetrieving,
            McpServerEventType.ToolsRetrieved,
            McpServerEventType.ToolsRetrievalFailed
        },
        ["Prompts"] = new[] {
            McpServerEventType.PromptsRetrieving,
            McpServerEventType.PromptsRetrieved,
            McpServerEventType.PromptsRetrievalFailed
        },
        ["Resources"] = new[] {
            McpServerEventType.ResourcesRetrieving,
            McpServerEventType.ResourcesRetrieved,
            McpServerEventType.ResourcesRetrievalFailed
        },
        ["Invocations"] = new[] {
            McpServerEventType.ToolInvocationAccepted,
            McpServerEventType.ToolInvoking,
            McpServerEventType.ToolInvoked,
            McpServerEventType.ToolInvocationFailed
        },
        ["Server"] = new[] {
            McpServerEventType.ServerCreated,
            McpServerEventType.ServerDeleted
        }
    };

    protected override void OnInitialized()
    {
        FilterState.OnChange += StateHasChanged;
    }

    private void OnEventTypeChanged(McpServerEventType eventType, bool enabled)
    {
        FilterState.SetEventTypeEnabled(eventType, enabled);
    }

    private void SelectAll()
    {
        FilterState.EnableAllEventTypes();
    }

    private void DeselectAll()
    {
        FilterState.DisableAllEventTypes();
    }

    private string GetEventTypeDisplay(McpServerEventType eventType) => eventType switch
    {
        McpServerEventType.Starting => "Starting",
        McpServerEventType.Started => "Started",
        McpServerEventType.StartFailed => "Start Failed",
        McpServerEventType.Stopping => "Stopping",
        McpServerEventType.Stopped => "Stopped",
        McpServerEventType.StopFailed => "Stop Failed",
        McpServerEventType.ConfigurationCreated => "Created",
        McpServerEventType.ConfigurationUpdated => "Updated",
        McpServerEventType.ConfigurationDeleted => "Deleted",
        McpServerEventType.ToolsRetrieving => "Retrieving",
        McpServerEventType.ToolsRetrieved => "Retrieved",
        McpServerEventType.ToolsRetrievalFailed => "Failed",
        McpServerEventType.PromptsRetrieving => "Retrieving",
        McpServerEventType.PromptsRetrieved => "Retrieved",
        McpServerEventType.PromptsRetrievalFailed => "Failed",
        McpServerEventType.ResourcesRetrieving => "Retrieving",
        McpServerEventType.ResourcesRetrieved => "Retrieved",
        McpServerEventType.ResourcesRetrievalFailed => "Failed",
        McpServerEventType.ToolInvocationAccepted => "Accepted",
        McpServerEventType.ToolInvoking => "Invoking",
        McpServerEventType.ToolInvoked => "Invoked",
        McpServerEventType.ToolInvocationFailed => "Failed",
        McpServerEventType.ServerCreated => "Created",
        McpServerEventType.ServerDeleted => "Deleted",
        _ => eventType.ToString()
    };

    public void Dispose()
    {
        FilterState.OnChange -= StateHasChanged;
    }
}
