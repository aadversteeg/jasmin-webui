@using Core.Application.McpServers
@using Core.Infrastructure.BlazorApp.ViewModels

<div class="tab-pane-content">
    @if (ToolsResult == null)
    {
        <div class="text-muted">
            <p>Loading tools...</p>
        </div>
    }
    else if (ToolsResult.Items.Count == 0)
    {
        <div class="text-muted">
            <p>No tools available for this server.</p>
        </div>
    }
    else
    {
        <ExpandableListHeader
            TimestampLabel="Retrieved at"
            Timestamp="@ToolsResult.RetrievedAt"
            OnExpandAll="ExpandAll"
            OnCollapseAll="CollapseAll" />

        <div class="items-container">
            @foreach (var tool in ToolsResult.Items)
            {
                <ExpandableItemCard
                    Name="@tool.Name"
                    Title="@tool.Title"
                    Description="@tool.Description"
                    IsExpanded="@_viewModel.IsExpanded(tool.Name)"
                    OnToggle="() => ToggleExpand(tool.Name)">
                    @if (tool.InputSchema?.Parameters.Count > 0)
                    {
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                @RenderParameterRows(tool.InputSchema.Parameters, 0)
                            </tbody>
                        </table>
                    }
                </ExpandableItemCard>
            }
        </div>

        @if (ToolsResult.Errors != null && ToolsResult.Errors.Count > 0)
        {
            <div class="alert alert-warning mt-3">
                <strong>Errors:</strong>
                <ul class="mb-0">
                    @foreach (var error in ToolsResult.Errors)
                    {
                        <li>@error.Code: @error.Message</li>
                    }
                </ul>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public McpServerMetadataResult<McpServerTool>? ToolsResult { get; set; }

    private readonly ExpandableItemsViewModel _viewModel = new();

    protected override void OnInitialized()
    {
        _viewModel.StateChanged += StateHasChanged;
    }

    private void ToggleExpand(string toolName)
    {
        _viewModel.ToggleExpand(toolName);
    }

    private void ExpandAll()
    {
        if (ToolsResult?.Items != null)
        {
            _viewModel.ExpandAll(ToolsResult.Items.Select(t => t.Name));
        }
    }

    private void CollapseAll()
    {
        _viewModel.CollapseAll();
    }

    private RenderFragment RenderParameterRows(IReadOnlyList<ToolInputParameter> parameters, int depth) => builder =>
    {
        var indent = depth * 16;

        foreach (var param in parameters)
        {
            builder.OpenElement(0, "tr");

            // Name column
            builder.OpenElement(1, "td");
            if (indent > 0)
            {
                builder.OpenElement(2, "span");
                builder.AddAttribute(3, "style", $"margin-left: {indent}px;");
                builder.OpenElement(4, "code");
                builder.AddContent(5, param.Name);
                builder.CloseElement();
                if (param.Required)
                {
                    builder.OpenElement(6, "span");
                    builder.AddAttribute(7, "class", "text-danger");
                    builder.AddContent(8, "*");
                    builder.CloseElement();
                }
                builder.CloseElement();
            }
            else
            {
                builder.OpenElement(9, "code");
                builder.AddContent(10, param.Name);
                builder.CloseElement();
                if (param.Required)
                {
                    builder.OpenElement(11, "span");
                    builder.AddAttribute(12, "class", "text-danger");
                    builder.AddContent(13, "*");
                    builder.CloseElement();
                }
            }
            builder.CloseElement();

            // Type column
            builder.OpenElement(14, "td");
            builder.OpenElement(15, "code");
            builder.AddAttribute(16, "class", "text-secondary");
            builder.AddContent(17, param.Type);
            builder.CloseElement();
            builder.CloseElement();

            // Description column
            builder.OpenElement(18, "td");
            builder.AddAttribute(19, "class", "text-muted");

            if (!string.IsNullOrEmpty(param.Description))
            {
                builder.AddContent(20, param.Description);
            }

            if (param.EnumValues != null && param.EnumValues.Count > 0)
            {
                if (!string.IsNullOrEmpty(param.Description))
                {
                    builder.AddContent(21, " ");
                }
                builder.OpenElement(22, "code");
                builder.AddContent(23, $"[{string.Join(", ", param.EnumValues)}]");
                builder.CloseElement();
            }

            if (param.Default != null)
            {
                builder.AddContent(24, " (default: ");
                builder.OpenElement(25, "code");
                builder.AddContent(26, param.Default.ToString());
                builder.CloseElement();
                builder.AddContent(27, ")");
            }

            builder.CloseElement();
            builder.CloseElement();

            // Nested schema for arrays of objects
            if (param.NestedSchema != null && param.NestedSchema.Parameters.Count > 0)
            {
                builder.AddContent(28, RenderParameterRows(param.NestedSchema.Parameters, depth + 1));
            }
        }
    };

    public void Dispose()
    {
        _viewModel.StateChanged -= StateHasChanged;
    }
}
