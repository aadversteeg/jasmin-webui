@inherits MvvmComponentBase<McpServerDialogViewModel>
@using Core.Application.McpServers
@using System.Text.Json

<ModalDialog IsOpen="@ViewModel.IsOpen"
             Title="@ViewModel.DialogTitle"
             MaxWidth="600"
             OnClose="() => ViewModel.CancelCommand.ExecuteAsync(null)">
    <ChildContent>
        @if (ViewModel.IsLoading)
        {
            <div class="d-flex justify-content-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else
        {
            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-outline-secondary btn-sm"
                        @onclick="ToggleInputMode"
                        disabled="@IsTesting"
                        title="@(_isJsonMode ? "Switch to Form view" : "Switch to JSON view")">
                    @(_isJsonMode ? "Form" : "JSON")
                </button>
            </div>

            @if (_isJsonMode)
            {
                <div class="mb-3">
                    <label for="serverName" class="form-label">Server Name <span class="text-danger">*</span></label>
                    <input type="text"
                           class="form-control"
                           id="serverName"
                           placeholder="my-server"
                           @bind="ViewModel.ServerName"
                           @bind:event="oninput"
                           disabled="@(ViewModel.IsEditMode || IsTesting)" />
                    @if (!ViewModel.IsEditMode)
                    {
                        <div class="form-text">A unique identifier for this server (no spaces)</div>
                    }
                </div>

                <div class="mb-3">
                    <label class="form-label">Configuration (JSON)</label>
                    <textarea class="form-control font-monospace"
                              rows="15"
                              value="@_jsonInputValue"
                              @oninput="OnJsonInputChanged"
                              disabled="@IsTesting"
                              placeholder='{"command": "npx", "args": [], "env": {}}'></textarea>
                    @if (!string.IsNullOrEmpty(_jsonParseError))
                    {
                        <div class="text-danger small mt-1">@_jsonParseError</div>
                    }
                    <div class="form-text">JSON with command, args (array), and env (object)</div>
                </div>
            }
            else
            {
            <div class="mb-3">
                <label for="serverName" class="form-label">Server Name <span class="text-danger">*</span></label>
                <input type="text"
                       class="form-control"
                       id="serverName"
                       placeholder="my-server"
                       @bind="ViewModel.ServerName"
                       @bind:event="oninput"
                       disabled="@(ViewModel.IsEditMode || IsTesting)" />
                @if (!ViewModel.IsEditMode)
                {
                    <div class="form-text">A unique identifier for this server (no spaces)</div>
                }
            </div>

            <div class="mb-3">
                <label for="command" class="form-label">Command <span class="text-danger">*</span></label>
                <input type="text"
                       class="form-control"
                       id="command"
                       placeholder="npx"
                       @bind="ViewModel.Command"
                       @bind:event="oninput"
                       disabled="@IsTesting" />
                <div class="form-text">The executable command (e.g., npx, docker, dotnet)</div>
            </div>

            <div class="mb-3">
                <SchemaBasedInput Parameter="@ArgumentsParameter"
                                  Value="@GetArgumentsValue()"
                                  OnValueChanged="OnArgumentsChanged" />
            </div>

            <div class="mb-3">
                <SchemaBasedInput Parameter="@EnvironmentVariablesParameter"
                                  Value="@GetEnvironmentVariablesValue()"
                                  OnValueChanged="OnEnvironmentVariablesChanged" />
            </div>
            }

            @if (!ViewModel.IsEditMode)
            {
                <div class="form-check mb-3">
                    <input type="checkbox"
                           class="form-check-input"
                           id="autoRefreshMetadata"
                           @bind="ViewModel.AutoRefreshMetadataOnAdd"
                           disabled="@IsTesting" />
                    <label class="form-check-label" for="autoRefreshMetadata">
                        Refresh metadata after adding
                    </label>
                    <div class="form-text">Automatically fetch tools, prompts, and resources</div>
                </div>
            }

            @if (!string.IsNullOrEmpty(ViewModel.ValidationError))
            {
                <div class="alert alert-danger py-2 mb-3">
                    @ViewModel.ValidationError
                </div>
            }

            @if (ViewModel.TestState != ConnectionTestState.None)
            {
                <div class="test-result @GetTestResultClass()">
                    @if (ViewModel.TestState == ConnectionTestState.Testing)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                        <span>Testing configuration...</span>
                    }
                    else if (ViewModel.TestState == ConnectionTestState.Success)
                    {
                        <span class="test-icon">&#10003;</span>
                        <span>Configuration test passed</span>
                    }
                    else if (ViewModel.TestState == ConnectionTestState.Failed)
                    {
                        <span class="test-icon">&#10007;</span>
                        <span>@(ViewModel.TestErrorMessage ?? "Configuration test failed")</span>
                    }
                </div>
            }
        }
    </ChildContent>
    <FooterContent>
        <button type="button"
                class="btn btn-outline-secondary"
                @onclick="TestConfiguration"
                disabled="@(!CanTest)">
            @if (IsTesting)
            {
                <span class="spinner-border spinner-border-sm me-1"></span>
                <span>Testing...</span>
            }
            else
            {
                <span>Test</span>
            }
        </button>
        <button type="button"
                class="btn btn-secondary"
                @onclick="Cancel">
            Cancel
        </button>
        <button type="button"
                class="btn btn-primary"
                @onclick="Save"
                disabled="@(!CanSave || ViewModel.IsRefreshingMetadata)">
            @if (ViewModel.IsRefreshingMetadata)
            {
                <span class="spinner-border spinner-border-sm me-1"></span>
                <span>Refreshing...</span>
            }
            else
            {
                <span>Save</span>
            }
        </button>
    </FooterContent>
</ModalDialog>

@code {
    private bool _isJsonMode = false;
    private string _jsonInputValue = "{}";
    private string? _jsonParseError = null;

    private bool IsTesting => ViewModel.TestState == ConnectionTestState.Testing;
    private bool CanTest => !IsTesting && HasValidCommand();
    private bool CanSave => ViewModel.TestState == ConnectionTestState.Success;

    private void OnJsonInputChanged(ChangeEventArgs e)
    {
        _jsonInputValue = e.Value?.ToString() ?? "{}";
        // Clear any previous parse error when user is typing
        _jsonParseError = null;
        // Force re-render to update CanTest
        StateHasChanged();
    }

    private bool HasValidCommand()
    {
        if (_isJsonMode)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(_jsonInputValue)) return false;
                var parsed = JsonSerializer.Deserialize<JsonElement>(_jsonInputValue);

                // Try direct format: {"command": "..."}
                if (parsed.TryGetProperty("command", out var cmd))
                {
                    return !string.IsNullOrWhiteSpace(cmd.GetString());
                }

                // Try wrapped format: {"serverName": {"command": "..."}}
                foreach (var prop in parsed.EnumerateObject())
                {
                    if (prop.Value.ValueKind == JsonValueKind.Object &&
                        prop.Value.TryGetProperty("command", out var nestedCmd))
                    {
                        return !string.IsNullOrWhiteSpace(nestedCmd.GetString());
                    }
                }

                return false;
            }
            catch
            {
                return false;
            }
        }
        return !string.IsNullOrWhiteSpace(ViewModel.Command);
    }

    private static readonly ToolInputParameter ArgumentsParameter = new(
        Name: "args",
        Type: "array",
        Description: "Command line arguments",
        Required: false,
        EnumValues: null,
        Default: null,
        NestedSchema: null,
        ItemsType: "string");

    private static readonly ToolInputParameter EnvironmentVariablesParameter = new(
        Name: "env",
        Type: "object",
        Description: "Environment variables",
        Required: false,
        EnumValues: null,
        Default: null,
        NestedSchema: null,
        ItemsType: null,
        AdditionalPropertiesType: "string");

    private object? GetArgumentsValue()
    {
        return ViewModel.Arguments.Cast<object?>().ToList();
    }

    private object? GetEnvironmentVariablesValue()
    {
        return ViewModel.EnvironmentVariables.ToDictionary(kvp => kvp.Key, kvp => (object?)kvp.Value);
    }

    private void OnArgumentsChanged(object? value)
    {
        if (value is List<object?> list)
        {
            ViewModel.Arguments = list.Select(x => x?.ToString() ?? string.Empty).ToList();
        }
    }

    private void OnEnvironmentVariablesChanged(object? value)
    {
        if (value is Dictionary<string, object?> dict)
        {
            ViewModel.EnvironmentVariables = dict.ToDictionary(
                kvp => kvp.Key,
                kvp => kvp.Value?.ToString() ?? string.Empty);
        }
    }

    private void ToggleInputMode()
    {
        if (_isJsonMode)
        {
            SyncJsonToForm();
        }
        else
        {
            SyncFormToJson();
        }
        _isJsonMode = !_isJsonMode;
    }

    private void SyncFormToJson()
    {
        try
        {
            var config = new Dictionary<string, object?>
            {
                ["command"] = ViewModel.Command,
                ["args"] = ViewModel.Arguments,
                ["env"] = ViewModel.EnvironmentVariables
            };
            var options = new JsonSerializerOptions { WriteIndented = true };
            _jsonInputValue = JsonSerializer.Serialize(config, options);
            _jsonParseError = null;
        }
        catch (Exception ex)
        {
            _jsonParseError = $"Error serializing: {ex.Message}";
        }
    }

    private void SyncJsonToForm()
    {
        try
        {
            // Reset all fields first
            ViewModel.Command = string.Empty;
            ViewModel.Arguments = new List<string>();
            ViewModel.EnvironmentVariables = new Dictionary<string, string>();

            if (string.IsNullOrWhiteSpace(_jsonInputValue))
            {
                _jsonParseError = null;
                return;
            }

            var parsed = JsonSerializer.Deserialize<JsonElement>(_jsonInputValue);
            JsonElement config = parsed;

            // Check if this is wrapped format: {"serverName": {"command": "..."}}
            if (!parsed.TryGetProperty("command", out _))
            {
                foreach (var prop in parsed.EnumerateObject())
                {
                    if (prop.Value.ValueKind == JsonValueKind.Object &&
                        prop.Value.TryGetProperty("command", out _))
                    {
                        // Found wrapped format - use the nested object as config
                        config = prop.Value;
                        // Also set server name if not already set
                        if (string.IsNullOrWhiteSpace(ViewModel.ServerName))
                        {
                            ViewModel.ServerName = prop.Name;
                        }
                        break;
                    }
                }
            }

            if (config.TryGetProperty("command", out var commandElement))
            {
                ViewModel.Command = commandElement.GetString() ?? string.Empty;
            }

            if (config.TryGetProperty("args", out var argsElement) && argsElement.ValueKind == JsonValueKind.Array)
            {
                ViewModel.Arguments = argsElement.EnumerateArray()
                    .Select(e => e.GetString() ?? string.Empty)
                    .ToList();
            }

            if (config.TryGetProperty("env", out var envElement) && envElement.ValueKind == JsonValueKind.Object)
            {
                ViewModel.EnvironmentVariables = envElement.EnumerateObject()
                    .ToDictionary(p => p.Name, p => p.Value.GetString() ?? string.Empty);
            }

            _jsonParseError = null;
        }
        catch (JsonException ex)
        {
            _jsonParseError = $"Invalid JSON: {ex.Message}";
        }
    }

    private async Task TestConfiguration()
    {
        if (_isJsonMode)
        {
            SyncJsonToForm();
            if (!string.IsNullOrEmpty(_jsonParseError))
            {
                return;
            }
        }
        await ViewModel.TestConfigurationCommand.ExecuteAsync(null);
    }

    private async Task Save()
    {
        if (_isJsonMode)
        {
            SyncJsonToForm();
            if (!string.IsNullOrEmpty(_jsonParseError))
            {
                return;
            }
        }
        await ViewModel.SaveCommand.ExecuteAsync(null);
    }

    private async Task Cancel()
    {
        await ViewModel.CancelCommand.ExecuteAsync(null);
    }

    private string GetTestResultClass() => ViewModel.TestState switch
    {
        ConnectionTestState.Testing => "test-testing",
        ConnectionTestState.Success => "test-success",
        ConnectionTestState.Failed => "test-failed",
        _ => ""
    };
}
