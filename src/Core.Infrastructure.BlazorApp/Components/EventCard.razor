@using System.Text.Json
@using Core.Domain.Events

<div class="event-card @GetEventClass() @(IsExpanded ? "expanded" : "")" @onclick="ToggleExpand">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <span class="badge @GetBadgeClass() event-type-badge me-2">@GetEventTypeDisplay()</span>
            <span class="event-server-name">@Event.ServerName</span>
        </div>
        <div class="d-flex align-items-center">
            <span class="event-timestamp me-2">@Event.Timestamp.ToString("HH:mm:ss.fff")</span>
            <span class="expand-icon">@(IsExpanded ? "\u25B2" : "\u25BC")</span>
        </div>
    </div>
    @if (!IsExpanded && (Event.InstanceId != null || Event.RequestId != null))
    {
        <div class="text-muted small mt-1">
            @if (Event.InstanceId != null)
            {
                <span class="me-3">Instance: <code>@TruncateId(Event.InstanceId)</code></span>
            }
            @if (Event.RequestId != null)
            {
                <span>Request: <code>@TruncateId(Event.RequestId)</code></span>
            }
        </div>
    }
    @if (!IsExpanded && Event.Errors?.Any() == true)
    {
        <div class="mt-2">
            <div class="alert alert-danger py-1 px-2 mb-0 small">
                <strong>@Event.Errors.First().Code:</strong> @Event.Errors.First().Message
                @if (Event.Errors.Count > 1)
                {
                    <span class="text-muted"> (+@(Event.Errors.Count - 1) more)</span>
                }
            </div>
        </div>
    }

    @if (IsExpanded)
    {
        <div class="event-details mt-3" @onclick:stopPropagation="true">
            <table class="table table-sm table-borderless mb-0">
                <tbody>
                    <tr>
                        <th scope="row" class="text-muted" style="width: 120px;">Server</th>
                        <td><code>@Event.ServerName</code></td>
                    </tr>
                    <tr>
                        <th scope="row" class="text-muted">Event Type</th>
                        <td><code>@Event.EventType</code></td>
                    </tr>
                    <tr>
                        <th scope="row" class="text-muted">Timestamp</th>
                        <td><code>@Event.Timestamp.ToString("yyyy-MM-dd HH:mm:ss.fff zzz")</code></td>
                    </tr>
                    @if (Event.InstanceId != null)
                    {
                        <tr>
                            <th scope="row" class="text-muted">Instance ID</th>
                            <td><code>@Event.InstanceId</code></td>
                        </tr>
                    }
                    @if (Event.RequestId != null)
                    {
                        <tr>
                            <th scope="row" class="text-muted">Request ID</th>
                            <td><code>@Event.RequestId</code></td>
                        </tr>
                    }
                </tbody>
            </table>

            @if (Event.Configuration != null)
            {
                <div class="mt-2">
                    <strong class="text-muted small">Configuration:</strong>
                    <div class="config-block mt-1">
                        <div><span class="text-muted">Command:</span> <code>@Event.Configuration.Command</code></div>
                        @if (Event.Configuration.Args.Any())
                        {
                            <div><span class="text-muted">Args:</span> <code>@string.Join(" ", Event.Configuration.Args)</code></div>
                        }
                        @if (Event.Configuration.Env.Any())
                        {
                            <div class="mt-1">
                                <span class="text-muted">Environment:</span>
                                <ul class="mb-0 ps-3">
                                    @foreach (var env in Event.Configuration.Env)
                                    {
                                        <li><code>@env.Key</code> = <code>@MaskEnvValue(env.Value)</code></li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (Event.OldConfiguration != null)
            {
                <div class="mt-2">
                    <strong class="text-muted small">Previous Configuration:</strong>
                    <div class="config-block mt-1 text-muted">
                        <div><span>Command:</span> <code>@Event.OldConfiguration.Command</code></div>
                        @if (Event.OldConfiguration.Args.Any())
                        {
                            <div><span>Args:</span> <code>@string.Join(" ", Event.OldConfiguration.Args)</code></div>
                        }
                    </div>
                </div>
            }

            @if (Event.Errors?.Any() == true)
            {
                <div class="mt-2">
                    <strong class="text-muted small">Errors:</strong>
                    @foreach (var error in Event.Errors)
                    {
                        <div class="alert alert-danger py-1 px-2 mb-1 small mt-1">
                            <strong>@error.Code:</strong> @error.Message
                        </div>
                    }
                </div>
            }

            <div class="mt-3">
                <strong class="text-muted small">Raw Event Data:</strong>
                <pre class="raw-event-data mt-1 mb-0">@GetFormattedRawJson()</pre>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public required McpServerEvent Event { get; set; }

    [Parameter]
    public bool IsExpanded { get; set; }

    [Parameter]
    public EventCallback OnToggle { get; set; }

    private async Task ToggleExpand()
    {
        await OnToggle.InvokeAsync();
    }

    private string GetEventClass() => Event.EventType switch
    {
        McpServerEventType.StartFailed or
        McpServerEventType.StopFailed or
        McpServerEventType.ToolsRetrievalFailed or
        McpServerEventType.PromptsRetrievalFailed or
        McpServerEventType.ResourcesRetrievalFailed or
        McpServerEventType.ToolInvocationFailed => "event-error",

        McpServerEventType.Started or
        McpServerEventType.ToolsRetrieved or
        McpServerEventType.PromptsRetrieved or
        McpServerEventType.ResourcesRetrieved or
        McpServerEventType.ToolInvoked => "event-success",

        McpServerEventType.Starting or
        McpServerEventType.Stopping or
        McpServerEventType.ToolsRetrieving or
        McpServerEventType.PromptsRetrieving or
        McpServerEventType.ResourcesRetrieving or
        McpServerEventType.ToolInvoking or
        McpServerEventType.ToolInvocationAccepted => "event-warning",

        _ => "event-info"
    };

    private string GetBadgeClass() => Event.EventType switch
    {
        McpServerEventType.StartFailed or
        McpServerEventType.StopFailed or
        McpServerEventType.ToolsRetrievalFailed or
        McpServerEventType.PromptsRetrievalFailed or
        McpServerEventType.ResourcesRetrievalFailed or
        McpServerEventType.ToolInvocationFailed => "bg-danger",

        McpServerEventType.Started or
        McpServerEventType.ToolsRetrieved or
        McpServerEventType.PromptsRetrieved or
        McpServerEventType.ResourcesRetrieved or
        McpServerEventType.ToolInvoked => "bg-success",

        McpServerEventType.Starting or
        McpServerEventType.Stopping or
        McpServerEventType.ToolsRetrieving or
        McpServerEventType.PromptsRetrieving or
        McpServerEventType.ResourcesRetrieving or
        McpServerEventType.ToolInvoking or
        McpServerEventType.ToolInvocationAccepted => "bg-warning text-dark",

        _ => "bg-info"
    };

    private string GetEventTypeDisplay() => Event.EventType switch
    {
        McpServerEventType.Starting => "Starting",
        McpServerEventType.Started => "Started",
        McpServerEventType.StartFailed => "Start Failed",
        McpServerEventType.Stopping => "Stopping",
        McpServerEventType.Stopped => "Stopped",
        McpServerEventType.StopFailed => "Stop Failed",
        McpServerEventType.ConfigurationCreated => "Config Created",
        McpServerEventType.ConfigurationUpdated => "Config Updated",
        McpServerEventType.ConfigurationDeleted => "Config Deleted",
        McpServerEventType.ToolsRetrieving => "Retrieving Tools",
        McpServerEventType.ToolsRetrieved => "Tools Retrieved",
        McpServerEventType.ToolsRetrievalFailed => "Tools Failed",
        McpServerEventType.PromptsRetrieving => "Retrieving Prompts",
        McpServerEventType.PromptsRetrieved => "Prompts Retrieved",
        McpServerEventType.PromptsRetrievalFailed => "Prompts Failed",
        McpServerEventType.ResourcesRetrieving => "Retrieving Resources",
        McpServerEventType.ResourcesRetrieved => "Resources Retrieved",
        McpServerEventType.ResourcesRetrievalFailed => "Resources Failed",
        McpServerEventType.ToolInvocationAccepted => "Invocation Accepted",
        McpServerEventType.ToolInvoking => "Invoking Tool",
        McpServerEventType.ToolInvoked => "Tool Invoked",
        McpServerEventType.ToolInvocationFailed => "Invocation Failed",
        McpServerEventType.ServerCreated => "Server Created",
        McpServerEventType.ServerDeleted => "Server Deleted",
        _ => Event.EventType.ToString()
    };

    private string TruncateId(string id)
    {
        if (id.Length <= 12) return id;
        return id[..8] + "...";
    }

    private string MaskEnvValue(string value)
    {
        // Mask potentially sensitive values
        if (value.Length <= 4) return "****";
        return value[..2] + "****" + value[^2..];
    }

    private static readonly JsonSerializerOptions JsonOptions = new()
    {
        WriteIndented = true
    };

    private string GetFormattedRawJson()
    {
        if (string.IsNullOrEmpty(Event.RawJson))
        {
            return "(no raw data available)";
        }

        // Pretty-print the raw JSON
        try
        {
            var jsonDoc = JsonDocument.Parse(Event.RawJson);
            return JsonSerializer.Serialize(jsonDoc, JsonOptions);
        }
        catch
        {
            return Event.RawJson;
        }
    }
}
