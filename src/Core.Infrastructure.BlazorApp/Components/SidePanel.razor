@inherits MvvmComponentBase<SidePanelViewModel>
@inject EventFilterViewModel FilterVM

<div class="side-panel" style="width: @(ViewModel.PanelWidth)px;">
    <div class="resize-handle" @onmousedown="StartResize"></div>

    <HeaderBar>
        <div class="d-flex align-items-center justify-content-between w-100">
            <h5 class="mb-0">Filters</h5>
            <span class="badge bg-secondary">@FilteredCount / @TotalCount</span>
        </div>
    </HeaderBar>

    <div class="panel-body">
        <FilterPanel Title="Servers"
                     IsExpanded="@FilterVM.IsServerFilterExpanded"
                     IsExpandedChanged="@(v => FilterVM.IsServerFilterExpanded = v)"
                     OnSelectAll="@(() => FilterVM.SelectAllServersCommand.Execute(null))"
                     OnDeselectAll="@(() => FilterVM.DeselectAllServersCommand.Execute(null))"
                     Groups="@GetServerGroups()" />

        <FilterPanel Title="Event Types"
                     IsExpanded="@FilterVM.IsEventTypeFilterExpanded"
                     IsExpandedChanged="@(v => FilterVM.IsEventTypeFilterExpanded = v)"
                     OnSelectAll="@(() => FilterVM.EnableAllEventTypesCommand.Execute(null))"
                     OnDeselectAll="@(() => FilterVM.DisableAllEventTypesCommand.Execute(null))"
                     Groups="@GetEventTypeGroups()" />
    </div>
</div>

@code {
    [Parameter]
    public int FilteredCount { get; set; }

    [Parameter]
    public int TotalCount { get; set; }

    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    private int _startX;
    private int _startWidth;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        FilterVM.FilterChanged += OnFilterChanged;
        FilterVM.PropertyChanged += OnPropertyChanged;
    }

    private void OnFilterChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        if (e.PropertyName == nameof(EventFilterViewModel.KnownServers) ||
            e.PropertyName == nameof(EventFilterViewModel.SelectedServers))
        {
            InvokeAsync(StateHasChanged);
        }
    }

    protected override void Dispose(bool disposing)
    {
        if (disposing)
        {
            FilterVM.FilterChanged -= OnFilterChanged;
            FilterVM.PropertyChanged -= OnPropertyChanged;
        }
        base.Dispose(disposing);
    }

    private async Task StartResize(MouseEventArgs e)
    {
        _startX = (int)e.ClientX;
        _startWidth = ViewModel.PanelWidth;

        await JS.InvokeVoidAsync("sidePanelResize.start",
            DotNetObjectReference.Create(this), _startX, _startWidth);
    }

    [JSInvokable]
    public void UpdateWidth(int deltaX)
    {
        var newWidth = _startWidth - deltaX;
        ViewModel.SetWidth(newWidth);
        StateHasChanged();
    }

    [JSInvokable]
    public void EndResize()
    {
    }

    private IEnumerable<FilterPanelGroup> GetServerGroups()
    {
        var items = FilterVM.KnownServers.Select(server => new FilterPanelItem(
            Id: $"server-{server}",
            Label: server,
            IsSelected: FilterVM.IsServerSelected(server),
            OnSelectionChanged: selected => FilterVM.SetServerSelected(server, selected)
        ));

        return new[] { new FilterPanelGroup("Servers", items) };
    }

    private IEnumerable<FilterPanelGroup> GetEventTypeGroups()
    {
        return FilterVM.EventTypeGroups.Select(group => new FilterPanelGroup(
            Name: group.Key,
            Items: group.Value.Select(eventType => new FilterPanelItem(
                Id: $"event-type-{eventType}",
                Label: EventFilterViewModel.GetEventTypeDisplayName(eventType),
                IsSelected: FilterVM.IsEventTypeEnabled(eventType),
                OnSelectionChanged: enabled => FilterVM.SetEventTypeEnabled(eventType, enabled)
            )),
            OnSelectAll: () => FilterVM.SelectEventTypeGroup(group.Key),
            OnDeselectAll: () => FilterVM.DeselectEventTypeGroup(group.Key)
        ));
    }
}
