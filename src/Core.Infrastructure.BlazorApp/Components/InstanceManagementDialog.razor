@using Core.Application.McpServers
@using Core.Application.Events
@using Core.Application.Storage
@using Core.Domain.Events
@using Core.Infrastructure.BlazorApp.ViewModels
@inherits Blazing.Mvvm.Components.MvvmComponentBase<InstanceManagementViewModel>
@inject IJSRuntime JS
@inject IUserPreferencesService UserPreferences

<ModalDialog IsOpen="@ViewModel.IsOpen"
             Title="@GetTitle()"
             OnClose="HandleClose"
             Width="90vw"
             Height="90vh">
    <ChildContent>
        <SplitPanel ContainerId="instance-mgmt-split-container"
                    InitialLeftWidthPercent="@_panelWidthPercent"
                    RightContentClass="log-panel-content"
                    OnWidthChanged="HandleWidthChanged">
            <LeftHeader>
                <h6 class="mb-0">Instances</h6>
                <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-outline-secondary btn-sm"
                            @onclick="HandleRefresh"
                            disabled="@ViewModel.IsLoading"
                            title="Refresh instance list">
                        Refresh
                    </button>
                    <button class="btn btn-primary btn-sm"
                            @onclick="HandleStartNew"
                            disabled="@ViewModel.IsStartingInstance">
                        @if (ViewModel.IsStartingInstance)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        }
                        + Start New
                    </button>
                </div>
            </LeftHeader>
            <LeftContent>
                @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
                {
                    <div class="alert alert-danger mb-2">@ViewModel.ErrorMessage</div>
                }

                @if (ViewModel.IsLoading)
                {
                    <div class="text-center py-4">
                        <div class="spinner-border text-secondary" role="status"></div>
                        <p class="mt-2 text-muted">Loading instances...</p>
                    </div>
                }
                else if (ViewModel.Instances.Count == 0)
                {
                    <div class="text-center py-4">
                        <p class="text-muted">No instances running</p>
                    </div>
                }
                else
                {
                    <div class="instance-list">
                        @foreach (var instance in ViewModel.Instances)
                        {
                            var isSelected = instance.InstanceId == ViewModel.SelectedInstanceId;
                            <div class="instance-card @(isSelected ? "selected" : "")"
                                 @onclick="() => HandleSelectInstance(instance.InstanceId)">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="instance-info">
                                        <div class="instance-id font-monospace">@instance.InstanceId</div>
                                        <small class="text-muted">Started: @FormatDateTime(instance.StartedAt)</small>
                                    </div>
                                    <button class="btn btn-outline-danger btn-sm"
                                            @onclick="() => HandleStop(instance.InstanceId)"
                                            @onclick:stopPropagation="true"
                                            disabled="@(ViewModel.StoppingInstanceId == instance.InstanceId)">
                                        @if (ViewModel.StoppingInstanceId == instance.InstanceId)
                                        {
                                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                        }
                                        Stop
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                }
            </LeftContent>
            <RightHeader>
                <div class="d-flex align-items-center justify-content-between w-100">
                    <ul class="nav nav-tabs instance-tabs mb-0">
                        <li class="nav-item">
                            <a class="nav-link @(_activeTab == LogsTab ? "active" : "")"
                               href="#" @onclick="() => SwitchTab(LogsTab)" @onclick:preventDefault>
                                Logs
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(_activeTab == EventsTab ? "active" : "")"
                               href="#" @onclick="() => SwitchTab(EventsTab)" @onclick:preventDefault>
                                Events
                                @if (GetInstanceEventCount() > 0)
                                {
                                    <span class="badge bg-secondary ms-1">@GetInstanceEventCount()</span>
                                }
                            </a>
                        </li>
                    </ul>
                    <div class="d-flex gap-2 align-items-center">
                        @if (!string.IsNullOrEmpty(ViewModel.SelectedInstanceId) && _activeTab == LogsTab)
                        {
                            @if (ViewModel.IsLogStreamConnected)
                            {
                                <span class="badge bg-success">Connected</span>
                            }
                            else if (!string.IsNullOrEmpty(ViewModel.LogStreamError))
                            {
                                <span class="badge bg-danger" title="@ViewModel.LogStreamError">Error</span>
                            }
                            else
                            {
                                <span class="badge bg-warning">Connecting...</span>
                            }
                        }
                    </div>
                </div>
            </RightHeader>
            <RightContent>
                @if (string.IsNullOrEmpty(ViewModel.SelectedInstanceId))
                {
                    <div class="text-center py-4">
                        <p class="text-muted">Select an instance to view its logs and events.</p>
                    </div>
                }
                else if (_activeTab == LogsTab)
                {
                    @if (ViewModel.LogEntries.Count == 0 && !ViewModel.IsLogStreamConnected)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                            <p class="mt-2 text-muted">Connecting to log stream...</p>
                        </div>
                    }
                    else
                    {
                        <div class="log-entries" id="instance-log-container">
                            @foreach (var entry in ViewModel.LogEntries)
                            {
                                <div class="log-line">
                                    <span class="log-timestamp">@entry.Timestamp.ToLocalTime().ToString("HH:mm:ss.fff")</span>
                                    <span class="log-text">@entry.Text</span>
                                </div>
                            }
                        </div>
                    }
                }
                else if (_activeTab == EventsTab)
                {
                    var instanceEvents = ViewModel.InstanceEvents;
                    @if (!instanceEvents.Any())
                    {
                        <div class="text-center py-4">
                            <p class="text-muted">No events yet for this instance.</p>
                        </div>
                    }
                    else
                    {
                        <div class="instance-events-area" id="instance-events-container">
                            <ExpandableListHeader
                                TimestampLabel="Last event at"
                                Timestamp="@instanceEvents.LastOrDefault()?.Timestamp"
                                OnExpandAll="ExpandAllEvents"
                                OnCollapseAll="CollapseAllEvents" />

                            @foreach (var evt in instanceEvents)
                            {
                                var eventId = InstanceManagementViewModel.GetEventId(evt);
                                <EventCard Event="evt"
                                           IsExpanded="@ViewModel.EventExpandState.IsExpanded(eventId)"
                                           OnToggle="() => ViewModel.EventExpandState.ToggleExpand(eventId)" />
                            }
                        </div>
                    }
                }
            </RightContent>
        </SplitPanel>
    </ChildContent>

    <FooterContent>
        <div class="d-flex justify-content-end w-100">
            <button class="btn btn-secondary" @onclick="HandleClose">
                Close
            </button>
        </div>
    </FooterContent>
</ModalDialog>

@code {
    private const string LogsTab = "logs";
    private const string EventsTab = "events";

    private double _panelWidthPercent = 33;
    private bool _autoScroll = true;
    private string _activeTab = LogsTab;
    private bool _eventsAutoScroll = true;
    private bool _pendingEventsScrollToBottom;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await UserPreferences.LoadAsync();
        _panelWidthPercent = UserPreferences.InstanceManagementPanelWidthPercent;
        ViewModel.InstancesChanged += HandleInstancesChanged;
        ViewModel.LogEntriesChanged += HandleLogEntriesChanged;
        ViewModel.EventsChanged += HandleEventsChanged;
        ViewModel.EventExpandState.StateChanged += HandleExpandStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_pendingEventsScrollToBottom)
        {
            _pendingEventsScrollToBottom = false;
            try
            {
                await JS.InvokeVoidAsync("scrollHelper.scrollToBottom", "instance-events-container");
            }
            catch
            {
                // Element may not exist yet
            }
        }
    }

    private void HandleWidthChanged(double newPercent)
    {
        _panelWidthPercent = newPercent;
        UserPreferences.InstanceManagementPanelWidthPercent = (int)newPercent;
    }

    private void HandleInstancesChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void HandleLogEntriesChanged()
    {
        InvokeAsync(async () =>
        {
            StateHasChanged();
            if (_activeTab == LogsTab)
            {
                await AutoScrollLogsIfNeeded();
            }
        });
    }

    private void HandleEventsChanged()
    {
        InvokeAsync(async () =>
        {
            StateHasChanged();
            if (_activeTab == EventsTab)
            {
                await AutoScrollEventsIfNeeded();
            }
        });
    }

    private void HandleExpandStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task AutoScrollLogsIfNeeded()
    {
        if (_autoScroll)
        {
            await Task.Yield();
            try
            {
                _autoScroll = await JS.InvokeAsync<bool>("scrollHelper.isScrolledToBottom", "instance-log-container");
                await JS.InvokeVoidAsync("scrollHelper.scrollToBottom", "instance-log-container");
            }
            catch
            {
                // Element may not exist yet
            }
        }
        else
        {
            try
            {
                _autoScroll = await JS.InvokeAsync<bool>("scrollHelper.isScrolledToBottom", "instance-log-container");
            }
            catch
            {
                // Element may not exist yet
            }
        }
    }

    private async Task AutoScrollEventsIfNeeded()
    {
        if (_eventsAutoScroll)
        {
            await Task.Yield();
            try
            {
                _eventsAutoScroll = await JS.InvokeAsync<bool>("scrollHelper.isScrolledToBottom", "instance-events-container");
                await JS.InvokeVoidAsync("scrollHelper.scrollToBottom", "instance-events-container");
            }
            catch
            {
                // Element may not exist yet
            }
        }
        else
        {
            try
            {
                _eventsAutoScroll = await JS.InvokeAsync<bool>("scrollHelper.isScrolledToBottom", "instance-events-container");
            }
            catch
            {
                // Element may not exist yet
            }
        }
    }

    private void SwitchTab(string tab)
    {
        _activeTab = tab;
        if (tab == EventsTab)
        {
            _eventsAutoScroll = true;
            _pendingEventsScrollToBottom = true;
        }
        else
        {
            _autoScroll = true;
        }
    }

    private int GetInstanceEventCount()
    {
        if (string.IsNullOrEmpty(ViewModel.SelectedInstanceId))
            return 0;
        return ViewModel.InstanceEvents.Count;
    }

    private void ExpandAllEvents()
    {
        ViewModel.ExpandAllInstanceEvents();
    }

    private void CollapseAllEvents()
    {
        ViewModel.CollapseAllInstanceEvents();
    }

    protected override void Dispose(bool disposing)
    {
        if (disposing)
        {
            ViewModel.InstancesChanged -= HandleInstancesChanged;
            ViewModel.LogEntriesChanged -= HandleLogEntriesChanged;
            ViewModel.EventsChanged -= HandleEventsChanged;
            ViewModel.EventExpandState.StateChanged -= HandleExpandStateChanged;
        }
        base.Dispose(disposing);
    }

    private string GetTitle()
    {
        return $"Instances: {ViewModel.ServerName}";
    }

    private string FormatDateTime(DateTimeOffset dateTime)
    {
        return dateTime.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss");
    }

    private async Task HandleSelectInstance(string instanceId)
    {
        _autoScroll = true;
        _eventsAutoScroll = true;
        await ViewModel.SelectInstanceCommand.ExecuteAsync(instanceId);
    }

    private async Task HandleStop(string instanceId)
    {
        await ViewModel.StopInstanceCommand.ExecuteAsync(instanceId);
    }

    private async Task HandleStartNew()
    {
        await ViewModel.StartNewInstanceCommand.ExecuteAsync(null);
    }

    private async Task HandleRefresh()
    {
        await ViewModel.RefreshCommand.ExecuteAsync(null);
    }

    private async Task HandleClose()
    {
        await ViewModel.CloseCommand.ExecuteAsync(null);
    }
}
