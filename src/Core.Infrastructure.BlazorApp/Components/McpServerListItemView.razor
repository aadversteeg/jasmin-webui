@using Core.Application.McpServers
@inject INavigationService NavigationService

<div class="mcp-server-item @(IsSelected ? "selected" : "")" @onclick="OnItemClick">
    <div class="server-row-top">
        <span class="status-indicator @GetStatusClass()" title="@GetStatusTitle()"></span>
        <span class="server-name">@Server.Name</span>
        <span class="badge bg-secondary instance-badge clickable"
              @onclick="OnBadgeClick"
              @onclick:stopPropagation="true"
              title="Click to manage instances">@Server.InstanceCount</span>
    </div>
    <div class="server-row-bottom">
        @if (GetTimestampText() is { } timestampText)
        {
            <span class="timestamp-text" title="@GetTimestampTooltip()">@timestampText</span>
        }
        <button class="btn btn-link btn-sm text-secondary action-btn p-0"
                @onclick="OnRefreshClick"
                @onclick:stopPropagation="true"
                disabled="@IsRefreshing"
                title="Refresh metadata">
            @if (IsRefreshing)
            {
                <span class="spinner-border spinner-border-sm" style="width: 12px; height: 12px;" role="status"></span>
            }
            else
            {
                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
            }
        </button>
        <button class="btn btn-link btn-sm text-secondary action-btn p-0"
                @onclick="OnEditClick"
                @onclick:stopPropagation="true"
                title="Edit server">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
            </svg>
        </button>
        <button class="btn btn-link btn-sm text-secondary action-btn p-0"
                @onclick="OnDeleteClick"
                @onclick:stopPropagation="true"
                title="Delete server">
            x
        </button>
    </div>
</div>

@code {
    [Parameter]
    public required McpServerListItem Server { get; set; }

    [Parameter]
    public bool IsSelected { get; set; }

    [Parameter]
    public EventCallback<string> OnDelete { get; set; }

    [Parameter]
    public EventCallback<string> OnEdit { get; set; }

    [Parameter]
    public EventCallback<string> OnManageInstances { get; set; }

    [Parameter]
    public EventCallback<string> OnRefresh { get; set; }

    [Parameter]
    public bool IsRefreshing { get; set; }

    private void OnItemClick()
    {
        NavigationService.NavigateTo($"/mcp-servers/{Uri.EscapeDataString(Server.Name)}");
    }

    private string GetStatusClass()
    {
        if (Server.InstanceCount > 0)
        {
            return "running";
        }

        return Server.Status switch
        {
            McpServerStatus.Verified => "verified",
            McpServerStatus.Failed => "failed",
            _ => "unknown"
        };
    }

    private string GetStatusTitle()
    {
        if (Server.InstanceCount > 0)
        {
            return $"Running ({Server.InstanceCount} instance{(Server.InstanceCount > 1 ? "s" : "")})";
        }

        return Server.Status switch
        {
            McpServerStatus.Verified => "Verified",
            McpServerStatus.Failed => "Failed to start",
            _ => "Unknown status"
        };
    }

    private string? GetTimestampText()
    {
        var (timestamp, _) = GetMostRecentTimestamp();
        if (timestamp == null) return null;
        return FormatRelativeTime(timestamp.Value);
    }

    private string? GetTimestampTooltip()
    {
        var (timestamp, label) = GetMostRecentTimestamp();
        if (timestamp == null) return null;
        return $"{label}: {timestamp.Value:yyyy-MM-dd HH:mm:ss}";
    }

    private (DateTimeOffset? Timestamp, string Label) GetMostRecentTimestamp()
    {
        var verified = Server.LastVerifiedAt;
        var metadata = Server.LastMetadataUpdateAt;

        if (verified == null && metadata == null)
        {
            return (null, "");
        }

        if (metadata != null && (verified == null || metadata > verified))
        {
            return (metadata, "Metadata updated");
        }

        return (verified, "Verified");
    }

    private static string FormatRelativeTime(DateTimeOffset timestamp)
    {
        var elapsed = DateTimeOffset.Now - timestamp;

        if (elapsed.TotalSeconds < 60)
            return "just now";
        if (elapsed.TotalMinutes < 60)
            return $"{(int)elapsed.TotalMinutes}m ago";
        if (elapsed.TotalHours < 24)
            return $"{(int)elapsed.TotalHours}h ago";
        if (elapsed.TotalDays < 30)
            return $"{(int)elapsed.TotalDays}d ago";

        return timestamp.ToString("MMM d");
    }

    private async Task OnDeleteClick()
    {
        await OnDelete.InvokeAsync(Server.Name);
    }

    private async Task OnEditClick()
    {
        await OnEdit.InvokeAsync(Server.Name);
    }

    private async Task OnBadgeClick()
    {
        await OnManageInstances.InvokeAsync(Server.Name);
    }

    private async Task OnRefreshClick()
    {
        await OnRefresh.InvokeAsync(Server.Name);
    }
}
