@using Core.Application.McpServers

<div class="parameter-input mb-3">
    <label class="form-label">
        <code>@Parameter.Name</code>
        @if (Parameter.Required)
        {
            <span class="text-danger">*</span>
        }
        @if (!string.IsNullOrEmpty(Parameter.Type))
        {
            <span class="text-muted small ms-2">(@Parameter.Type)</span>
        }
    </label>

    @if (!string.IsNullOrEmpty(Parameter.Description))
    {
        <div class="form-text mb-1">@Parameter.Description</div>
    }

    @if (Parameter.EnumValues != null && Parameter.EnumValues.Count > 0)
    {
        <select class="form-select" @onchange="HandleSelectChange">
            <option value="">Select a value...</option>
            @foreach (var enumValue in Parameter.EnumValues)
            {
                <option value="@enumValue" selected="@(GetStringValue() == enumValue)">@enumValue</option>
            }
        </select>
    }
    else if (Parameter.Type.ToLowerInvariant() == "boolean")
    {
        <div class="form-check">
            <input type="checkbox"
                   class="form-check-input"
                   id="@($"param-{Parameter.Name}")"
                   checked="@GetBoolValue()"
                   @onchange="HandleCheckboxChange" />
            <label class="form-check-label" for="@($"param-{Parameter.Name}")">
                @(GetBoolValue() ? "true" : "false")
            </label>
        </div>
    }
    else if (Parameter.Type.ToLowerInvariant() == "integer" || Parameter.Type.ToLowerInvariant() == "number")
    {
        <input type="number"
               class="form-control"
               value="@GetStringValue()"
               step="@(Parameter.Type.ToLowerInvariant() == "integer" ? "1" : "any")"
               @onchange="HandleInputChange"
               placeholder="@GetPlaceholder()" />
    }
    else if (Parameter.Type.ToLowerInvariant() == "object" || Parameter.Type.ToLowerInvariant() == "array")
    {
        <textarea class="form-control font-monospace"
                  rows="4"
                  @onchange="HandleInputChange"
                  placeholder="@GetJsonPlaceholder()">@GetStringValue()</textarea>
    }
    else
    {
        <input type="text"
               class="form-control"
               value="@GetStringValue()"
               @onchange="HandleInputChange"
               placeholder="@GetPlaceholder()" />
    }

    @if (Parameter.Default != null)
    {
        <div class="form-text text-muted">
            Default: <code>@Parameter.Default</code>
        </div>
    }
</div>

@code {
    [Parameter]
    public required ToolInputParameter Parameter { get; set; }

    [Parameter]
    public object? Value { get; set; }

    [Parameter]
    public EventCallback<object?> OnValueChanged { get; set; }

    private string GetStringValue()
    {
        return Value?.ToString() ?? "";
    }

    private bool GetBoolValue()
    {
        if (Value is bool b)
        {
            return b;
        }
        if (Value is string s && bool.TryParse(s, out var result))
        {
            return result;
        }
        return false;
    }

    private string GetPlaceholder()
    {
        if (Parameter.Required)
        {
            return "Required";
        }
        return "Optional";
    }

    private string GetJsonPlaceholder()
    {
        return Parameter.Type.ToLowerInvariant() == "array"
            ? "Enter JSON array, e.g., [\"value1\", \"value2\"]"
            : "Enter JSON object, e.g., {\"key\": \"value\"}";
    }

    private async Task HandleInputChange(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString();
        await OnValueChanged.InvokeAsync(string.IsNullOrEmpty(newValue) ? null : newValue);
    }

    private async Task HandleSelectChange(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString();
        await OnValueChanged.InvokeAsync(string.IsNullOrEmpty(newValue) ? null : newValue);
    }

    private async Task HandleCheckboxChange(ChangeEventArgs e)
    {
        var newValue = e.Value is bool b && b;
        await OnValueChanged.InvokeAsync(newValue);
    }
}
