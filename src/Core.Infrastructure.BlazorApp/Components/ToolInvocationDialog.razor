@using Core.Application.McpServers
@using Core.Application.Storage
@using Core.Infrastructure.BlazorApp.ViewModels
@using System.Text.Json
@inherits Blazing.Mvvm.Components.MvvmComponentBase<ToolInvocationViewModel>
@inject IUserPreferencesService UserPreferences
@inject IJSRuntime JS

<ModalDialog IsOpen="@ViewModel.IsOpen"
             Title="@GetTitle()"
             OnClose="HandleClose"
             Width="90vw"
             Height="90vh">
    <ChildContent>
        @if (ViewModel.IsStartingInstance)
        {
            <div class="text-center py-4">
                <div class="spinner-border text-secondary" role="status"></div>
                <p class="mt-2 text-muted">Starting instance...</p>
            </div>
        }
        else
        {
            <div id="tool-invocation-split-container" class="split-container">
                @* Left Panel - Input *@
                <div class="split-panel input-panel" style="width: @(_inputPanelWidthPercent)%;">
                    <div class="panel-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Input</h6>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary btn-sm"
                                    @onclick="ToggleInputMode"
                                    title="@(_isJsonMode ? "Switch to Form view" : "Switch to JSON view")">
                                @(_isJsonMode ? "Form" : "JSON")
                            </button>
                            <button class="btn btn-primary btn-sm"
                                    @onclick="HandleInvoke"
                                    disabled="@(!CanInvoke())">
                                @if (ViewModel.IsInvoking)
                                {
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                }
                                Invoke
                            </button>
                        </div>
                    </div>
                    <div class="panel-content">
                        @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage) && ViewModel.CurrentView == InvocationView.Input)
                        {
                            <div class="alert alert-danger">@ViewModel.ErrorMessage</div>
                        }

                        @if (ViewModel.Tool?.InputSchema?.Parameters.Count > 0)
                        {
                            @if (_isJsonMode)
                            {
                                <textarea class="form-control font-monospace"
                                          rows="20"
                                          @bind="_jsonInputValue"
                                          @bind:event="oninput"
                                          placeholder="Enter JSON input..."></textarea>
                                @if (!string.IsNullOrEmpty(_jsonParseError))
                                {
                                    <div class="text-danger small mt-1">@_jsonParseError</div>
                                }
                            }
                            else
                            {
                                <form @onsubmit="HandleSubmit" @onsubmit:preventDefault="true">
                                    @foreach (var param in ViewModel.Tool.InputSchema.Parameters)
                                    {
                                        <SchemaBasedInput Parameter="param"
                                                         Value="@GetInputValue(param.Name)"
                                                         OnValueChanged="v => ViewModel.SetInputValue(param.Name, v)" />
                                    }
                                </form>
                            }
                        }
                        else
                        {
                            <p class="text-muted">This tool has no input parameters.</p>
                        }
                    </div>
                </div>

                @* Resizer *@
                <div class="split-resizer" @onmousedown="StartResize"></div>

                @* Right Panel - Output *@
                <div class="split-panel output-panel" style="width: @(100 - _inputPanelWidthPercent)%;">
                    <div class="panel-header">
                        <h6 class="mb-0">Output</h6>
                    </div>
                    <div class="panel-content">
                        @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage) && ViewModel.CurrentView == InvocationView.Output)
                        {
                            <div class="alert alert-danger">@ViewModel.ErrorMessage</div>
                        }
                        else if (ViewModel.Result != null)
                        {
                            @if (ViewModel.Result.IsError)
                            {
                                <div class="alert alert-warning mb-3">
                                    The tool returned an error response.
                                </div>
                            }

                            <div class="output-container">
                                @foreach (var block in ViewModel.Result.Content)
                                {
                                    @if (block.Type == "text" && !string.IsNullOrEmpty(block.Text))
                                    {
                                        <pre class="output-text">@block.Text</pre>
                                    }
                                    else if (block.Type == "image" && !string.IsNullOrEmpty(block.Data))
                                    {
                                        <div class="output-image">
                                            <img src="data:@(block.MimeType ?? "image/png");base64,@block.Data" alt="Tool output" />
                                        </div>
                                    }
                                    else if (block.Type == "resource" && !string.IsNullOrEmpty(block.Uri))
                                    {
                                        <div class="output-resource">
                                            <a href="@block.Uri" target="_blank" rel="noopener noreferrer">@block.Uri</a>
                                        </div>
                                    }
                                }

                                @if (ViewModel.Result.StructuredContent.HasValue)
                                {
                                    <details class="mt-3">
                                        <summary class="text-muted small">Structured Content</summary>
                                        <pre class="output-json mt-2">@FormatJson(ViewModel.Result.StructuredContent.Value)</pre>
                                    </details>
                                }
                            </div>
                        }
                        else if (ViewModel.IsInvoking)
                        {
                            <div class="text-center py-4">
                                <div class="spinner-border text-secondary" role="status"></div>
                                <p class="mt-2 text-muted">Invoking tool...</p>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">Click "Invoke" to run the tool and see results here.</p>
                        }
                    </div>
                </div>
            </div>
        }
    </ChildContent>

    <FooterContent>
        <button class="btn btn-secondary" @onclick="HandleClose">
            Close
        </button>
    </FooterContent>
</ModalDialog>

@code {
    private double _inputPanelWidthPercent = 33;
    private double _startWidthPercent;
    private bool _isJsonMode = false;
    private string _jsonInputValue = "{}";
    private string? _jsonParseError = null;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await UserPreferences.LoadAsync();
        _inputPanelWidthPercent = UserPreferences.ToolInvocationInputPanelWidthPercent;
    }

    private void ToggleInputMode()
    {
        if (_isJsonMode)
        {
            // Switching from JSON to Form - parse JSON and populate values
            SyncJsonToForm();
        }
        else
        {
            // Switching from Form to JSON - serialize values to JSON
            SyncFormToJson();
        }
        _isJsonMode = !_isJsonMode;
    }

    private void SyncFormToJson()
    {
        try
        {
            var options = new JsonSerializerOptions { WriteIndented = true };
            _jsonInputValue = JsonSerializer.Serialize(ViewModel.InputValues, options);
            _jsonParseError = null;
        }
        catch (Exception ex)
        {
            _jsonParseError = $"Error serializing: {ex.Message}";
        }
    }

    private void SyncJsonToForm()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_jsonInputValue))
            {
                ViewModel.InputValues.Clear();
                _jsonParseError = null;
                return;
            }

            var parsed = JsonSerializer.Deserialize<Dictionary<string, JsonElement>>(_jsonInputValue);
            if (parsed != null)
            {
                ViewModel.InputValues.Clear();
                foreach (var kvp in parsed)
                {
                    ViewModel.InputValues[kvp.Key] = ConvertJsonElement(kvp.Value);
                }
            }
            _jsonParseError = null;
        }
        catch (JsonException ex)
        {
            _jsonParseError = $"Invalid JSON: {ex.Message}";
        }
    }

    private object? ConvertJsonElement(JsonElement element)
    {
        return element.ValueKind switch
        {
            JsonValueKind.String => element.GetString(),
            JsonValueKind.Number => element.TryGetInt64(out var l) ? l : element.GetDouble(),
            JsonValueKind.True => true,
            JsonValueKind.False => false,
            JsonValueKind.Null => null,
            JsonValueKind.Array => element.EnumerateArray().Select(ConvertJsonElement).ToList(),
            JsonValueKind.Object => element.EnumerateObject().ToDictionary(p => p.Name, p => ConvertJsonElement(p.Value)),
            _ => null
        };
    }

    private string GetTitle()
    {
        if (ViewModel.Tool == null)
        {
            return "Invoke Tool";
        }
        return $"Invoke: {ViewModel.Tool.Name}";
    }

    private object? GetInputValue(string paramName)
    {
        return ViewModel.InputValues.TryGetValue(paramName, out var value) ? value : null;
    }

    private bool CanInvoke()
    {
        return !ViewModel.IsStartingInstance
            && !ViewModel.IsInvoking
            && !string.IsNullOrEmpty(ViewModel.InstanceId);
    }

    private async Task HandleSubmit()
    {
        if (CanInvoke())
        {
            await ViewModel.InvokeCommand.ExecuteAsync(null);
        }
    }

    private async Task HandleInvoke()
    {
        if (_isJsonMode)
        {
            SyncJsonToForm();
            if (!string.IsNullOrEmpty(_jsonParseError))
            {
                return; // Don't invoke if JSON is invalid
            }
        }
        await ViewModel.InvokeCommand.ExecuteAsync(null);
    }

    private async Task HandleClose()
    {
        await ViewModel.CloseCommand.ExecuteAsync(null);
    }

    private async Task StartResize(MouseEventArgs e)
    {
        _startWidthPercent = _inputPanelWidthPercent;
        await JS.InvokeVoidAsync("splitPanelResize.start",
            DotNetObjectReference.Create(this),
            "tool-invocation-split-container",
            (int)e.ClientX,
            _inputPanelWidthPercent);
    }

    [JSInvokable]
    public void UpdateWidthPercent(double newPercent)
    {
        _inputPanelWidthPercent = Math.Clamp(newPercent, 20, 80);
        StateHasChanged();
    }

    [JSInvokable]
    public void EndResize()
    {
        UserPreferences.ToolInvocationInputPanelWidthPercent = (int)_inputPanelWidthPercent;
    }

    private static string FormatJson(System.Text.Json.JsonElement element)
    {
        return System.Text.Json.JsonSerializer.Serialize(element, new System.Text.Json.JsonSerializerOptions
        {
            WriteIndented = true
        });
    }
}
