@using Core.Application.McpServers
@using Core.Application.Storage
@using Core.Infrastructure.BlazorApp.ViewModels
@inherits Blazing.Mvvm.Components.MvvmComponentBase<ToolInvocationViewModel>
@inject IUserPreferencesService UserPreferences
@inject IJSRuntime JS

<ModalDialog IsOpen="@ViewModel.IsOpen"
             Title="@GetTitle()"
             OnClose="HandleClose"
             Width="90vw"
             Height="90vh">
    <ChildContent>
        @if (ViewModel.IsStartingInstance)
        {
            <div class="text-center py-4">
                <div class="spinner-border text-secondary" role="status"></div>
                <p class="mt-2 text-muted">Starting instance...</p>
            </div>
        }
        else
        {
            <div id="tool-invocation-split-container" class="split-container">
                @* Left Panel - Input *@
                <div class="split-panel input-panel" style="width: @(_inputPanelWidthPercent)%;">
                    <div class="panel-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Input</h6>
                        <button class="btn btn-primary btn-sm"
                                @onclick="HandleInvoke"
                                disabled="@(!CanInvoke())">
                            @if (ViewModel.IsInvoking)
                            {
                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            }
                            Invoke
                        </button>
                    </div>
                    <div class="panel-content">
                        @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage) && ViewModel.CurrentView == InvocationView.Input)
                        {
                            <div class="alert alert-danger">@ViewModel.ErrorMessage</div>
                        }

                        @if (ViewModel.Tool?.InputSchema?.Parameters.Count > 0)
                        {
                            <form @onsubmit="HandleSubmit" @onsubmit:preventDefault="true">
                                @foreach (var param in ViewModel.Tool.InputSchema.Parameters)
                                {
                                    <ToolParameterInput Parameter="param"
                                                       Value="@GetInputValue(param.Name)"
                                                       OnValueChanged="v => ViewModel.SetInputValue(param.Name, v)" />
                                }
                            </form>
                        }
                        else
                        {
                            <p class="text-muted">This tool has no input parameters.</p>
                        }
                    </div>
                </div>

                @* Resizer *@
                <div class="split-resizer" @onmousedown="StartResize"></div>

                @* Right Panel - Output *@
                <div class="split-panel output-panel" style="width: @(100 - _inputPanelWidthPercent)%;">
                    <div class="panel-header">
                        <h6 class="mb-0">Output</h6>
                    </div>
                    <div class="panel-content">
                        @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage) && ViewModel.CurrentView == InvocationView.Output)
                        {
                            <div class="alert alert-danger">@ViewModel.ErrorMessage</div>
                        }
                        else if (ViewModel.Result != null)
                        {
                            @if (ViewModel.Result.IsError)
                            {
                                <div class="alert alert-warning mb-3">
                                    The tool returned an error response.
                                </div>
                            }

                            <div class="output-container">
                                @foreach (var block in ViewModel.Result.Content)
                                {
                                    @if (block.Type == "text" && !string.IsNullOrEmpty(block.Text))
                                    {
                                        <pre class="output-text">@block.Text</pre>
                                    }
                                    else if (block.Type == "image" && !string.IsNullOrEmpty(block.Data))
                                    {
                                        <div class="output-image">
                                            <img src="data:@(block.MimeType ?? "image/png");base64,@block.Data" alt="Tool output" />
                                        </div>
                                    }
                                    else if (block.Type == "resource" && !string.IsNullOrEmpty(block.Uri))
                                    {
                                        <div class="output-resource">
                                            <a href="@block.Uri" target="_blank" rel="noopener noreferrer">@block.Uri</a>
                                        </div>
                                    }
                                }

                                @if (ViewModel.Result.StructuredContent.HasValue)
                                {
                                    <details class="mt-3">
                                        <summary class="text-muted small">Structured Content</summary>
                                        <pre class="output-json mt-2">@FormatJson(ViewModel.Result.StructuredContent.Value)</pre>
                                    </details>
                                }
                            </div>
                        }
                        else if (ViewModel.IsInvoking)
                        {
                            <div class="text-center py-4">
                                <div class="spinner-border text-secondary" role="status"></div>
                                <p class="mt-2 text-muted">Invoking tool...</p>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">Click "Invoke" to run the tool and see results here.</p>
                        }
                    </div>
                </div>
            </div>
        }
    </ChildContent>

    <FooterContent>
        <button class="btn btn-secondary" @onclick="HandleClose">
            Close
        </button>
    </FooterContent>
</ModalDialog>

@code {
    private double _inputPanelWidthPercent = 33;
    private double _startWidthPercent;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await UserPreferences.LoadAsync();
        _inputPanelWidthPercent = UserPreferences.ToolInvocationInputPanelWidthPercent;
    }

    private string GetTitle()
    {
        if (ViewModel.Tool == null)
        {
            return "Invoke Tool";
        }
        return $"Invoke: {ViewModel.Tool.Name}";
    }

    private object? GetInputValue(string paramName)
    {
        return ViewModel.InputValues.TryGetValue(paramName, out var value) ? value : null;
    }

    private bool CanInvoke()
    {
        return !ViewModel.IsStartingInstance
            && !ViewModel.IsInvoking
            && !string.IsNullOrEmpty(ViewModel.InstanceId);
    }

    private async Task HandleSubmit()
    {
        if (CanInvoke())
        {
            await ViewModel.InvokeCommand.ExecuteAsync(null);
        }
    }

    private async Task HandleInvoke()
    {
        await ViewModel.InvokeCommand.ExecuteAsync(null);
    }

    private async Task HandleClose()
    {
        await ViewModel.CloseCommand.ExecuteAsync(null);
    }

    private async Task StartResize(MouseEventArgs e)
    {
        _startWidthPercent = _inputPanelWidthPercent;
        await JS.InvokeVoidAsync("splitPanelResize.start",
            DotNetObjectReference.Create(this),
            "tool-invocation-split-container",
            (int)e.ClientX,
            _inputPanelWidthPercent);
    }

    [JSInvokable]
    public void UpdateWidthPercent(double newPercent)
    {
        _inputPanelWidthPercent = Math.Clamp(newPercent, 20, 80);
        StateHasChanged();
    }

    [JSInvokable]
    public void EndResize()
    {
        UserPreferences.ToolInvocationInputPanelWidthPercent = (int)_inputPanelWidthPercent;
    }

    private static string FormatJson(System.Text.Json.JsonElement element)
    {
        return System.Text.Json.JsonSerializer.Serialize(element, new System.Text.Json.JsonSerializerOptions
        {
            WriteIndented = true
        });
    }
}
