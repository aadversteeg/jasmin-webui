@inherits MvvmComponentBase<LeftPanelViewModel>
@inject McpServerListViewModel ServerListVM
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<SlidePanel Position="PanelPosition.Left"
            Width="@ViewModel.PanelWidth"
            WidthChanged="@OnWidthChanged">
    <Header>
        <div class="d-flex align-items-center justify-content-between w-100">
            <h5 class="mb-0">MCP Servers</h5>
        </div>
    </Header>
    <ChildContent>
        <div class="mcp-server-list">
            @if (!ServerListVM.Servers.Any())
            {
                <div class="empty-state text-muted text-center py-3">
                    No MCP servers
                </div>
            }
            else
            {
                @foreach (var server in ServerListVM.Servers)
                {
                    <McpServerListItemView Server="server"
                                          IsSelected="IsServerSelected(server.Name)"
                                          OnDelete="HandleDeleteRequest" />
                }
            }
        </div>
    </ChildContent>
</SlidePanel>

@code {
    private bool _isDisposed;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        ServerListVM.ServersChanged += HandleServersChanged;
        ServerListVM.DeleteConfirmationRequested += HandleDeleteConfirmation;
        NavigationManager.LocationChanged += HandleLocationChanged;
    }

    private void OnWidthChanged(int newWidth)
    {
        ViewModel.SetWidth(newWidth);
    }

    private void HandleServersChanged()
    {
        if (_isDisposed) return;
        InvokeAsync(StateHasChanged);
    }

    private void HandleLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        if (_isDisposed) return;
        InvokeAsync(StateHasChanged);
    }

    private bool IsServerSelected(string serverName)
    {
        var relativePath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        if (relativePath.StartsWith("mcp-servers/", StringComparison.OrdinalIgnoreCase))
        {
            var selectedName = Uri.UnescapeDataString(relativePath["mcp-servers/".Length..]);
            return string.Equals(selectedName, serverName, StringComparison.OrdinalIgnoreCase);
        }
        return false;
    }

    private async Task<bool> HandleDeleteConfirmation(string serverName)
    {
        return await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{serverName}'?");
    }

    private async Task HandleDeleteRequest(string serverName)
    {
        await ServerListVM.DeleteServerCommand.ExecuteAsync(serverName);
    }

    protected override void Dispose(bool disposing)
    {
        if (disposing)
        {
            _isDisposed = true;
            ServerListVM.ServersChanged -= HandleServersChanged;
            ServerListVM.DeleteConfirmationRequested -= HandleDeleteConfirmation;
            NavigationManager.LocationChanged -= HandleLocationChanged;
        }
        base.Dispose(disposing);
    }
}
