@inherits MvvmComponentBase<LeftPanelViewModel>
@using Core.Application.McpServers
@inject McpServerListViewModel ServerListVM
@inject NavigationManager NavigationManager
@inject ConfirmationDialogViewModel ConfirmDialogVM
@inject McpServerDialogViewModel McpServerDialogVM
@inject InstanceManagementViewModel InstanceManagementVM

<SlidePanel Position="PanelPosition.Left"
            Width="@ViewModel.PanelWidth"
            WidthChanged="@OnWidthChanged">
    <Header>
        <h5 class="mb-0">MCP Servers</h5>
    </Header>
    <ChildContent>
        <div class="mcp-server-list">
            <div class="server-toolbar d-flex gap-2 p-2">
                <div class="position-relative flex-grow-1">
                    <input type="text"
                           class="form-control form-control-sm pe-4"
                           placeholder="Filter servers..."
                           @bind="_filterText"
                           @bind:event="oninput" />
                    @if (!string.IsNullOrEmpty(_filterText))
                    {
                        <button type="button"
                                class="btn btn-sm position-absolute top-50 end-0 translate-middle-y border-0 p-0 pe-2"
                                style="background: transparent; line-height: 1;"
                                @onclick="ClearFilter"
                                title="Clear filter">
                            <span class="text-muted">&times;</span>
                        </button>
                    }
                </div>
                <button class="btn btn-sm btn-outline-primary flex-shrink-0"
                        @onclick="HandleAddServer"
                        title="Add MCP Server">
                    + Add
                </button>
            </div>
            @if (!FilteredServers.Any())
            {
                <div class="empty-state text-muted text-center py-3">
                    @if (string.IsNullOrWhiteSpace(_filterText))
                    {
                        <span>No MCP servers</span>
                    }
                    else
                    {
                        <span>No servers matching "@_filterText"</span>
                    }
                </div>
            }
            else
            {
                @foreach (var server in FilteredServers)
                {
                    <McpServerListItemView Server="server"
                                          IsSelected="IsServerSelected(server.Name)"
                                          OnDelete="HandleDeleteRequest"
                                          OnEdit="HandleEditRequest"
                                          OnManageInstances="HandleManageInstances" />
                }
            }
        </div>
    </ChildContent>
</SlidePanel>

<InstanceManagementDialog />

@code {
    private bool _isDisposed;
    private string _filterText = string.Empty;

    private IEnumerable<McpServerListItem> FilteredServers => string.IsNullOrWhiteSpace(_filterText)
        ? ServerListVM.Servers
        : ServerListVM.Servers.Where(s => s.Name.Contains(_filterText, StringComparison.OrdinalIgnoreCase));

    protected override void OnInitialized()
    {
        base.OnInitialized();
        ServerListVM.ServersChanged += HandleServersChanged;
        ServerListVM.DeleteConfirmationRequested += HandleDeleteConfirmation;
        NavigationManager.LocationChanged += HandleLocationChanged;
        McpServerDialogVM.ServerSaved += HandleServerSaved;
    }

    private void OnWidthChanged(int newWidth)
    {
        ViewModel.SetWidth(newWidth);
    }

    private void HandleServersChanged()
    {
        if (_isDisposed) return;
        InvokeAsync(StateHasChanged);
    }

    private void HandleLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        if (_isDisposed) return;
        InvokeAsync(StateHasChanged);
    }

    private bool IsServerSelected(string serverName)
    {
        var relativePath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        if (relativePath.StartsWith("mcp-servers/", StringComparison.OrdinalIgnoreCase))
        {
            var pathAfterPrefix = relativePath["mcp-servers/".Length..];
            var slashIndex = pathAfterPrefix.IndexOf('/');
            var selectedName = slashIndex >= 0 ? pathAfterPrefix[..slashIndex] : pathAfterPrefix;
            selectedName = Uri.UnescapeDataString(selectedName);
            return string.Equals(selectedName, serverName, StringComparison.OrdinalIgnoreCase);
        }
        return false;
    }

    private async Task<bool> HandleDeleteConfirmation(string serverName)
    {
        return await ConfirmDialogVM.ShowAsync(
            "Delete Server",
            $"Are you sure you want to delete '{serverName}'?");
    }

    private async Task HandleDeleteRequest(string serverName)
    {
        await ServerListVM.DeleteServerCommand.ExecuteAsync(serverName);
    }

    private void HandleAddServer()
    {
        McpServerDialogVM.OpenForAddCommand.Execute(null);
    }

    private void ClearFilter()
    {
        _filterText = string.Empty;
    }

    private async Task HandleEditRequest(string serverName)
    {
        await McpServerDialogVM.OpenForEditCommand.ExecuteAsync(serverName);
    }

    private async Task HandleManageInstances(string serverName)
    {
        await InstanceManagementVM.OpenCommand.ExecuteAsync(serverName);
    }

    private async void HandleServerSaved(string serverName)
    {
        // Refresh the server list
        await ServerListVM.RefreshCommand.ExecuteAsync(null);
    }

    protected override void Dispose(bool disposing)
    {
        if (disposing)
        {
            _isDisposed = true;
            ServerListVM.ServersChanged -= HandleServersChanged;
            ServerListVM.DeleteConfirmationRequested -= HandleDeleteConfirmation;
            NavigationManager.LocationChanged -= HandleLocationChanged;
            McpServerDialogVM.ServerSaved -= HandleServerSaved;
        }
        base.Dispose(disposing);
    }
}
