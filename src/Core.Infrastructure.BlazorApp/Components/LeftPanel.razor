@inherits MvvmComponentBase<LeftPanelViewModel>
@inject McpServerListViewModel ServerListVM
@inject NavigationManager NavigationManager
@inject ConfirmationDialogViewModel ConfirmDialogVM
@inject McpServerDialogViewModel McpServerDialogVM
@inject InstanceManagementViewModel InstanceManagementVM

<SlidePanel Position="PanelPosition.Left"
            Width="@ViewModel.PanelWidth"
            WidthChanged="@OnWidthChanged">
    <Header>
        <div class="d-flex align-items-center justify-content-between w-100">
            <h5 class="mb-0">MCP Servers</h5>
            <button class="btn btn-sm btn-outline-primary"
                    @onclick="HandleAddServer"
                    title="Add MCP Server">
                + Add
            </button>
        </div>
    </Header>
    <ChildContent>
        <div class="mcp-server-list">
            @if (!ServerListVM.Servers.Any())
            {
                <div class="empty-state text-muted text-center py-3">
                    No MCP servers
                </div>
            }
            else
            {
                @foreach (var server in ServerListVM.Servers)
                {
                    <McpServerListItemView Server="server"
                                          IsSelected="IsServerSelected(server.Name)"
                                          OnDelete="HandleDeleteRequest"
                                          OnEdit="HandleEditRequest"
                                          OnManageInstances="HandleManageInstances" />
                }
            }
        </div>
    </ChildContent>
</SlidePanel>

<InstanceManagementDialog />

@code {
    private bool _isDisposed;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        ServerListVM.ServersChanged += HandleServersChanged;
        ServerListVM.DeleteConfirmationRequested += HandleDeleteConfirmation;
        NavigationManager.LocationChanged += HandleLocationChanged;
        McpServerDialogVM.ServerSaved += HandleServerSaved;
    }

    private void OnWidthChanged(int newWidth)
    {
        ViewModel.SetWidth(newWidth);
    }

    private void HandleServersChanged()
    {
        if (_isDisposed) return;
        InvokeAsync(StateHasChanged);
    }

    private void HandleLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        if (_isDisposed) return;
        InvokeAsync(StateHasChanged);
    }

    private bool IsServerSelected(string serverName)
    {
        var relativePath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        if (relativePath.StartsWith("mcp-servers/", StringComparison.OrdinalIgnoreCase))
        {
            var pathAfterPrefix = relativePath["mcp-servers/".Length..];
            var slashIndex = pathAfterPrefix.IndexOf('/');
            var selectedName = slashIndex >= 0 ? pathAfterPrefix[..slashIndex] : pathAfterPrefix;
            selectedName = Uri.UnescapeDataString(selectedName);
            return string.Equals(selectedName, serverName, StringComparison.OrdinalIgnoreCase);
        }
        return false;
    }

    private async Task<bool> HandleDeleteConfirmation(string serverName)
    {
        return await ConfirmDialogVM.ShowAsync(
            "Delete Server",
            $"Are you sure you want to delete '{serverName}'?");
    }

    private async Task HandleDeleteRequest(string serverName)
    {
        await ServerListVM.DeleteServerCommand.ExecuteAsync(serverName);
    }

    private void HandleAddServer()
    {
        McpServerDialogVM.OpenForAddCommand.Execute(null);
    }

    private async Task HandleEditRequest(string serverName)
    {
        await McpServerDialogVM.OpenForEditCommand.ExecuteAsync(serverName);
    }

    private async Task HandleManageInstances(string serverName)
    {
        await InstanceManagementVM.OpenCommand.ExecuteAsync(serverName);
    }

    private async void HandleServerSaved(string serverName)
    {
        // Refresh the server list
        await ServerListVM.RefreshCommand.ExecuteAsync(null);
    }

    protected override void Dispose(bool disposing)
    {
        if (disposing)
        {
            _isDisposed = true;
            ServerListVM.ServersChanged -= HandleServersChanged;
            ServerListVM.DeleteConfirmationRequested -= HandleDeleteConfirmation;
            NavigationManager.LocationChanged -= HandleLocationChanged;
            McpServerDialogVM.ServerSaved -= HandleServerSaved;
        }
        base.Dispose(disposing);
    }
}
