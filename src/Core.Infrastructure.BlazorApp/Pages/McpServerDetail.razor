@page "/mcp-servers/{ServerName}"
@page "/mcp-servers/{ServerName}/{TabName}"
@inherits MvvmComponentBase<ServerDetailViewModel>
@using Core.Application.McpServers
@using System.Web
@inject INavigationService NavigationService
@inject NavigationManager NavManager
@inject SidePanelViewModel SidePanelVM
@inject LeftPanelViewModel LeftPanelVM
@inject ToolInvocationViewModel ToolInvocationVM
@inject PromptInvocationViewModel PromptInvocationVM
@inject ResourceViewerViewModel ResourceViewerVM
@implements IDisposable

<PageTitle>@ServerName - Jasmin</PageTitle>

<HeaderBar>
    <div class="container-fluid">
        <div class="row g-3 align-items-center">
            <div class="col-auto">
                <button class="btn btn-outline-secondary"
                        @onclick="() => LeftPanelVM.TogglePanelCommand.Execute(null)"
                        title="@(LeftPanelVM.IsPanelOpen ? "Close servers" : "Open servers")">
                    @(LeftPanelVM.IsPanelOpen ? "◀" : "▶")
                </button>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-secondary" @onclick="NavigateHome" title="Back to events">
                    <svg width="1em" height="1em" viewBox="0 0 24 24"><path d="M12 3L4 9v12h16V9l-8-6z" fill="currentColor"/><rect x="10" y="13" width="4" height="8" fill="white"/></svg>
                </button>
            </div>
            <div class="col-auto">
                <span class="text-muted small">MCP Servers</span>
                <span class="text-muted small mx-1">/</span>
                <span class="small fw-bold">@ServerName</span>
            </div>
            <div class="col"></div>
            <div class="col-auto d-flex gap-2">
                <button class="btn btn-outline-secondary"
                        @onclick="() => SidePanelVM.TogglePanelCommand.Execute(null)"
                        title="@(SidePanelVM.IsPanelOpen ? "Close panel" : "Open panel")">
                    @(SidePanelVM.IsPanelOpen ? "▶" : "◀")
                </button>
            </div>
        </div>
    </div>
</HeaderBar>

<div class="detail-area">
    @if (ViewModel.IsLoading)
    {
        <div class="empty-state">
            <div class="spinner-border text-secondary" role="status"></div>
            <p class="mt-2">Loading server details...</p>
        </div>
    }
    else if (ViewModel.LoadError != null)
    {
        <div class="empty-state">
            <div class="alert alert-danger">@ViewModel.LoadError</div>
        </div>
    }
    else
    {
        <TabbedView Tabs="ViewModel.Tabs" ActiveTabId="@ViewModel.ActiveTab">
            @switch (ViewModel.ActiveTab)
            {
                case "configuration":
                    <ConfigurationTab Configuration="@ViewModel.Configuration" ServerName="@ServerName" />
                    break;
                case "tools":
                    <ToolsTab ToolsResult="@ViewModel.ToolsResult" OnInvokeTool="HandleInvokeTool" />
                    break;
                case "prompts":
                    <PromptsTab PromptsResult="@ViewModel.PromptsResult" OnInvokePrompt="HandleInvokePrompt" />
                    break;
                case "resources":
                    <ResourcesTab ResourcesResult="@ViewModel.ResourcesResult" OnViewResource="HandleViewResource" />
                    break;
                default:
                    <ConfigurationTab Configuration="@ViewModel.Configuration" ServerName="@ServerName" />
                    break;
            }
        </TabbedView>
    }
</div>

<ToolInvocationDialog />
<PromptInvocationDialog />
<ResourceViewer />

@code {
    [Parameter]
    public string ServerName { get; set; } = string.Empty;

    [Parameter]
    public string? TabName { get; set; }

    private bool _isSubscribed;
    private bool _isHandlingLocationChange;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        NavigationService.SetPageContext(SidePanelContentType.ServerDetail, ServerName);

        // Subscribe to resource changes to update URL
        ResourceViewerVM.ResourceChanged += OnResourceChanged;
        NavManager.LocationChanged += OnLocationChanged;
        _isSubscribed = true;
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        ViewModel.ServerName = ServerName;
        ViewModel.SetActiveTab(TabName);
        NavigationService.SetPageContext(SidePanelContentType.ServerDetail, ServerName);
        await ViewModel.InitializeDataAsync();

        // Check for resource query parameter (deep linking)
        await CheckForResourceQueryParam();
    }

    private async Task CheckForResourceQueryParam()
    {
        var uri = NavManager.ToAbsoluteUri(NavManager.Uri);
        var query = HttpUtility.ParseQueryString(uri.Query);
        var resourceValue = query["resource"];

        if (!string.IsNullOrEmpty(resourceValue) && !ResourceViewerVM.IsOpen)
        {
            var resourceUri = Uri.UnescapeDataString(resourceValue);
            // Open the resource viewer with the deep-linked resource
            await ResourceViewerVM.OpenByUriAsync(
                resourceUri,
                ServerName,
                ViewModel.ServerUrl ?? string.Empty,
                GetPageBasePath(),
                raiseEvent: false); // Don't raise event since we're syncing from URL
        }
    }

    private void OnResourceChanged(object? sender, ResourceChangedEventArgs e)
    {
        if (_isHandlingLocationChange)
            return;

        // Update URL based on resource state
        var basePath = GetPageBasePath();
        string newUrl;

        if (e.ResourceUri != null)
        {
            // Resource opened - add query param
            var encodedUri = Uri.EscapeDataString(e.ResourceUri);
            newUrl = $"{basePath}?resource={encodedUri}";
        }
        else
        {
            // Resource closed - remove query param
            newUrl = basePath;
        }

        // Navigate without forcing a page reload
        NavManager.NavigateTo(newUrl, forceLoad: false);
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        // Check if resource param changed (browser back/forward)
        var uri = NavManager.ToAbsoluteUri(e.Location);
        var query = HttpUtility.ParseQueryString(uri.Query);
        var resourceValue = query["resource"];

        _isHandlingLocationChange = true;
        try
        {
            if (!string.IsNullOrEmpty(resourceValue))
            {
                var resourceUri = Uri.UnescapeDataString(resourceValue);
                // Check if we need to navigate to a different resource
                if (!ResourceViewerVM.IsOpen || ResourceViewerVM.CurrentResourceUri != resourceUri)
                {
                    await ResourceViewerVM.OpenByUriAsync(
                        resourceUri,
                        ServerName,
                        ViewModel.ServerUrl ?? string.Empty,
                        GetPageBasePath(),
                        raiseEvent: false);
                    await InvokeAsync(StateHasChanged);
                }
            }
            else if (ResourceViewerVM.IsOpen)
            {
                // No resource param but viewer is open - close it
                await ResourceViewerVM.CloseAsync(raiseEvent: false);
                await InvokeAsync(StateHasChanged);
            }
        }
        finally
        {
            _isHandlingLocationChange = false;
        }
    }

    private string GetPageBasePath()
    {
        // Build the base path without query params
        var path = $"/mcp-servers/{ServerName}";
        if (!string.IsNullOrEmpty(TabName))
        {
            path += $"/{TabName}";
        }
        return path;
    }

    private void NavigateHome()
    {
        NavigationService.NavigateToHome();
    }

    private async Task HandleInvokeTool(McpServerTool tool)
    {
        var tools = ViewModel.ToolsResult?.Items ?? Array.Empty<McpServerTool>();
        await ToolInvocationVM.OpenAsync(tool, ServerName, ViewModel.ServerUrl, tools);
    }

    private async Task HandleInvokePrompt(McpServerPrompt prompt)
    {
        var prompts = ViewModel.PromptsResult?.Items ?? Array.Empty<McpServerPrompt>();
        await PromptInvocationVM.OpenAsync(prompt, ServerName, ViewModel.ServerUrl, prompts);
    }

    private async Task HandleViewResource(McpServerResource resource)
    {
        await ResourceViewerVM.OpenAsync(
            resource,
            ServerName,
            ViewModel.ServerUrl ?? string.Empty,
            GetPageBasePath());
    }

    public new void Dispose()
    {
        if (_isSubscribed)
        {
            ResourceViewerVM.ResourceChanged -= OnResourceChanged;
            NavManager.LocationChanged -= OnLocationChanged;
            _isSubscribed = false;
        }
        base.Dispose();
    }
}
