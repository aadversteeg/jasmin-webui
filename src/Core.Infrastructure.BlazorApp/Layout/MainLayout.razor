@inherits LayoutComponentBase
@implements IDisposable
@inject SidePanelViewModel SidePanelVM
@inject LeftPanelViewModel LeftPanelVM
@inject EventViewerViewModel EventViewerVM
@inject EventFilterViewModel FilterVM
@inject INavigationService NavigationService

<div class="app-container">
    @if (LeftPanelVM.IsPanelOpen)
    {
        <LeftPanel />
    }

    <div class="main-content">
        @Body
    </div>

    @if (SidePanelVM.IsPanelOpen)
    {
        @switch (NavigationService.CurrentSidePanelContent)
        {
            case SidePanelContentType.EventFilters:
                <SidePanel FilteredCount="@FilteredEventCount" TotalCount="@TotalEventCount" />
                break;
            case SidePanelContentType.ServerDetail:
                <ServerDetailSidePanel />
                break;
        }
    }
</div>

@code {
    private int FilteredEventCount => EventViewerVM.FilteredEvents.Count();
    private int TotalEventCount => EventViewerVM.Events.Count;

    protected override async Task OnInitializedAsync()
    {
        // Initialize ViewModels before first render to load saved state.
        // EventViewerVM must be initialized here (not just in Index.razor) so that
        // the SSE connection and server list load regardless of which page loads first.
        await SidePanelVM.OnInitializedAsync();
        await LeftPanelVM.OnInitializedAsync();
        await EventViewerVM.OnInitializedAsync();

        SidePanelVM.PropertyChanged += OnViewModelPropertyChanged;
        LeftPanelVM.PropertyChanged += OnViewModelPropertyChanged;
        FilterVM.FilterChanged += OnFilterChanged;
        EventViewerVM.EventAdded += OnEventAdded;
        NavigationService.PageContextChanged += OnPageContextChanged;
    }

    private void OnViewModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        if (e.PropertyName == nameof(SidePanelViewModel.IsPanelOpen) ||
            e.PropertyName == nameof(LeftPanelViewModel.IsPanelOpen))
        {
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnFilterChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnEventAdded()
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnPageContextChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        SidePanelVM.PropertyChanged -= OnViewModelPropertyChanged;
        LeftPanelVM.PropertyChanged -= OnViewModelPropertyChanged;
        FilterVM.FilterChanged -= OnFilterChanged;
        EventViewerVM.EventAdded -= OnEventAdded;
        NavigationService.PageContextChanged -= OnPageContextChanged;
    }
}
