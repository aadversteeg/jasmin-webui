@inherits LayoutComponentBase
@implements IDisposable
@inject SidePanelViewModel SidePanelVM
@inject LeftPanelViewModel LeftPanelVM
@inject EventViewerViewModel EventViewerVM
@inject EventFilterViewModel FilterVM

<div class="app-container">
    @if (LeftPanelVM.IsPanelOpen)
    {
        <LeftPanel />
    }

    <div class="main-content">
        @Body
    </div>

    @if (SidePanelVM.IsPanelOpen)
    {
        <SidePanel FilteredCount="@FilteredEventCount" TotalCount="@TotalEventCount" />
    }
</div>

@code {
    private int FilteredEventCount => EventViewerVM.FilteredEvents.Count();
    private int TotalEventCount => EventViewerVM.Events.Count;

    protected override async Task OnInitializedAsync()
    {
        // Initialize panel ViewModels before first render to load saved panel state
        await SidePanelVM.OnInitializedAsync();
        await LeftPanelVM.OnInitializedAsync();

        SidePanelVM.PropertyChanged += OnViewModelPropertyChanged;
        LeftPanelVM.PropertyChanged += OnViewModelPropertyChanged;
        FilterVM.FilterChanged += OnFilterChanged;
        EventViewerVM.EventAdded += OnEventAdded;
    }

    private void OnViewModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        if (e.PropertyName == nameof(SidePanelViewModel.IsPanelOpen) ||
            e.PropertyName == nameof(LeftPanelViewModel.IsPanelOpen))
        {
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnFilterChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnEventAdded()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        SidePanelVM.PropertyChanged -= OnViewModelPropertyChanged;
        LeftPanelVM.PropertyChanged -= OnViewModelPropertyChanged;
        FilterVM.FilterChanged -= OnFilterChanged;
        EventViewerVM.EventAdded -= OnEventAdded;
    }
}
